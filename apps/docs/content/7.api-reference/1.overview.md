# API Reference

Second Brain exposes several server API endpoints for querying content data, relationships, and statistics. These endpoints power the app's features like the knowledge graph, backlinks, and stats dashboard.

## Base URL

All API endpoints are available under `/api/` in both development and production.

```
Development: http://localhost:3000/api/
Production:  https://your-domain.com/api/
```

## Available Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/graph` | GET | Full knowledge graph data |
| `/api/backlinks` | GET | Index of all wiki-link connections |
| `/api/mentions` | GET | Find unlinked text mentions |
| `/api/stats` | GET | Aggregated statistics (cached) |
| `/api/note-graph/[slug]` | GET | Per-note graph with connections |
| `/api/raw-content/[slug]` | GET | Raw Markdown content |

---

## `/api/graph`

Returns the complete knowledge graph including all nodes (content items) and edges (wiki-link connections).

### Request

```http
GET /api/graph
```

No parameters required.

### Response

```typescript
interface GraphData {
  nodes: GraphNode[]
  edges: GraphEdge[]
}

interface GraphNode {
  id: string           // Slug (unique identifier)
  title: string        // Display title
  type: string         // Content type (youtube, book, note, etc.)
  tags: string[]       // Associated tags
  authors: string[]    // Author slugs
  summary?: string     // Optional summary text
  connections: number  // Total edge count
  maps: string[]       // MOC slugs this note belongs to
  isMap: boolean       // True if type === 'map'
}

interface GraphEdge {
  source: string  // Source node slug
  target: string  // Target node slug
}
```

### Example Response

```json
{
  "nodes": [
    {
      "id": "atomic-habits",
      "title": "Atomic Habits",
      "type": "book",
      "tags": ["habits", "productivity"],
      "authors": ["james-clear"],
      "summary": "Build good habits and break bad ones...",
      "connections": 12,
      "maps": ["personal-development"],
      "isMap": false
    },
    {
      "id": "personal-development",
      "title": "Personal Development",
      "type": "map",
      "tags": ["moc"],
      "authors": [],
      "connections": 15,
      "maps": [],
      "isMap": true
    }
  ],
  "edges": [
    { "source": "personal-development", "target": "atomic-habits" },
    { "source": "atomic-habits", "target": "habit-stacking" }
  ]
}
```

### Usage

Used by:
- `KnowledgeGraph.vue` - Full graph visualization
- Stats dashboard for connection metrics

---

## `/api/backlinks`

Returns an index mapping each slug to the items that link to it via `[[wiki-links]]`.

### Request

```http
GET /api/backlinks
```

No parameters required.

### Response

```typescript
interface BacklinksIndex {
  [targetSlug: string]: BacklinkItem[]
}

interface BacklinkItem {
  slug: string   // Slug of the linking item
  title: string  // Title of the linking item
  type: string   // Content type of the linking item
}
```

### Example Response

```json
{
  "atomic-habits": [
    { "slug": "book-notes-2024", "title": "Book Notes 2024", "type": "note" },
    { "slug": "habit-stacking", "title": "Habit Stacking", "type": "evergreen" }
  ],
  "james-clear": [
    { "slug": "atomic-habits", "title": "Atomic Habits", "type": "book" }
  ]
}
```

### Usage

Used by:
- `ContentBacklinksSection.vue` - Displays backlinks on content pages
- Connection counting in various components

---

## `/api/mentions`

Finds unlinked mentions - places where a note's title appears in other content without an explicit `[[wiki-link]]`.

### Request

```http
GET /api/mentions?slug={slug}&title={title}
```

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `slug` | string | Yes | The slug of the target note |
| `title` | string | Yes | The title to search for (min 3 characters) |

### Response

```typescript
type MentionItem[] = {
  slug: string             // Slug of the mentioning item
  title: string            // Title of the mentioning item
  type: string             // Content type
  snippet: string          // Context around the mention
  highlightedSnippet: string  // Snippet with <mark> tags
}[]
```

### Example Request

```http
GET /api/mentions?slug=atomic-habits&title=Atomic%20Habits
```

### Example Response

```json
[
  {
    "slug": "productivity-tips",
    "title": "Productivity Tips",
    "type": "note",
    "snippet": "...as described in Atomic Habits, small changes compound...",
    "highlightedSnippet": "...as described in <mark>Atomic Habits</mark>, small changes compound..."
  }
]
```

### Notes

- Returns empty array if title is less than 3 characters (prevents false positives)
- Excludes items that already have a wiki-link to the target
- Uses word-boundary matching to avoid partial matches

### Usage

Used by:
- `ContentBacklinksSection.vue` - Displays "Mentions" section on content pages

---

## `/api/stats`

Returns aggregated statistics about the knowledge base. This endpoint is **cached for 10 minutes** with stale-while-revalidate (SWR) strategy.

### Request

```http
GET /api/stats
```

No parameters required.

### Response

```typescript
interface StatsData {
  total: number              // Total content count
  byType: TypeCount[]        // Counts per content type
  byTag: TagCount[]          // Counts per tag (sorted by count)
  byAuthor: AuthorCount[]    // Counts per author (sorted by count)
  byMonth: MonthCount[]      // Counts per month (sorted chronologically)
  quality: QualityMetrics    // Content quality metrics
  connections: ConnectionMetrics  // Graph connection metrics
  thisWeek: number           // Items added in last 7 days
}

interface TypeCount {
  type: string
  count: number
}

interface TagCount {
  tag: string
  count: number
}

interface AuthorCount {
  author: string
  count: number
}

interface MonthCount {
  month: string  // Format: "YYYY-MM"
  count: number
}

interface QualityMetrics {
  withSummary: number  // Items with summary field
  withNotes: number    // Items with notes field
  total: number        // Total items
}

interface ConnectionMetrics {
  totalEdges: number      // Total wiki-link connections
  avgPerNote: number      // Average connections per note
  orphanCount: number     // Notes with 0 connections
  orphanPercent: number   // Orphan percentage (one decimal)
  hubs: HubNode[]         // Top 5 most connected notes
  orphans: OrphanNode[]   // All orphan notes
}

interface HubNode {
  id: string
  title: string
  type: string
  connections: number
}

interface OrphanNode {
  id: string
  title: string
  type: string
}
```

### Example Response

```json
{
  "total": 150,
  "byType": [
    { "type": "article", "count": 45 },
    { "type": "book", "count": 30 },
    { "type": "youtube", "count": 25 }
  ],
  "byTag": [
    { "tag": "productivity", "count": 42 },
    { "tag": "programming", "count": 38 }
  ],
  "byAuthor": [
    { "author": "james-clear", "count": 5 },
    { "author": "cal-newport", "count": 3 }
  ],
  "byMonth": [
    { "month": "2024-01", "count": 12 },
    { "month": "2024-02", "count": 18 }
  ],
  "quality": {
    "withSummary": 120,
    "withNotes": 80,
    "total": 150
  },
  "connections": {
    "totalEdges": 320,
    "avgPerNote": 2.1,
    "orphanCount": 15,
    "orphanPercent": 10.0,
    "hubs": [
      { "id": "personal-development", "title": "Personal Development", "type": "map", "connections": 25 }
    ],
    "orphans": [
      { "id": "random-note", "title": "Random Note", "type": "note" }
    ]
  },
  "thisWeek": 5
}
```

### Caching

- **Max Age**: 10 minutes
- **Strategy**: Stale-while-revalidate (SWR)
- Internally fetches `/api/graph` for connection metrics

### Usage

Used by:
- `StatsOverview.vue` - Overview cards
- `StatsBarChart.vue` - Type/tag/author distributions
- `StatsLineChart.vue` - Monthly timeline

---

## `/api/note-graph/[slug]`

Returns a focused graph centered on a specific note, including direct connections (L1) and second-degree connections (L2).

### Request

```http
GET /api/note-graph/{slug}
```

### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `slug` | string | Yes | The slug of the center note |

### Response

Returns `null` if the slug doesn't exist.

```typescript
interface NoteGraphData {
  center: NoteGraphNode           // The center note
  connected: NoteGraphNode[]      // Connected notes (L1 and L2)
  edges: NoteGraphEdge[]          // All edges in the graph
}

interface NoteGraphNode {
  id: string
  title: string
  type: string
  isCenter?: boolean    // True only for center node
  level?: 0 | 1 | 2     // 0=center, 1=direct, 2=second-degree
}

interface NoteGraphEdge {
  source: string
  target: string
  level?: 1 | 2         // 1=center↔L1, 2=L1↔L2
}
```

### Example Request

```http
GET /api/note-graph/atomic-habits
```

### Example Response

```json
{
  "center": {
    "id": "atomic-habits",
    "title": "Atomic Habits",
    "type": "book",
    "isCenter": true,
    "level": 0
  },
  "connected": [
    { "id": "habit-stacking", "title": "Habit Stacking", "type": "evergreen", "level": 1 },
    { "id": "james-clear", "title": "James Clear", "type": "note", "level": 1 },
    { "id": "productivity-systems", "title": "Productivity Systems", "type": "note", "level": 2 }
  ],
  "edges": [
    { "source": "atomic-habits", "target": "habit-stacking", "level": 1 },
    { "source": "atomic-habits", "target": "james-clear", "level": 1 },
    { "source": "habit-stacking", "target": "productivity-systems", "level": 2 }
  ]
}
```

### Notes

- L1 nodes include both outgoing links and backlinks
- L2 nodes are limited to 20 maximum to prevent visual clutter
- Second-degree connections are discovered from L1 nodes' links

### Usage

Used by:
- `NoteGraph.vue` - Radial mini-graph on content pages

---

## `/api/raw-content/[slug]`

Returns the raw Markdown content of a note, including frontmatter.

### Request

```http
GET /api/raw-content/{slug}
```

### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `slug` | string | Yes | The slug of the content item |

### Response

```typescript
interface RawContentResponse {
  raw: string  // Full Markdown file contents
}
```

### Example Request

```http
GET /api/raw-content/atomic-habits
```

### Example Response

```json
{
  "raw": "---\ntitle: Atomic Habits\ntype: book\nauthors:\n  - james-clear\ntags:\n  - habits\n  - productivity\n---\n\n## Summary\n\nAtomic Habits is about building good habits..."
}
```

### Error Responses

| Status | Message | Cause |
|--------|---------|-------|
| 400 | Slug is required | Missing slug parameter |
| 404 | Content not found | File doesn't exist |

### Usage

Used by:
- Claude Code skills for reading/editing content
- Export functionality

---

## Error Handling

All endpoints follow consistent error handling patterns:

### Graph/Stats Endpoints
Return empty data structures on error:
- `/api/graph` → `{ nodes: [], edges: [] }`
- `/api/backlinks` → `{}`
- `/api/mentions` → `[]`
- `/api/stats` → Full structure with zero values
- `/api/note-graph/[slug]` → `null`

### Content Endpoints
Throw HTTP errors:
- `/api/raw-content/[slug]` → `400` or `404` errors

### Server-Side Logging

All endpoints log errors to the server console with `console.error()` for debugging.

---

## Implementation Details

### Data Sources

All endpoints query the `content` collection via `@nuxt/content`:

```typescript
import { queryCollection } from '@nuxt/content/server'

const content = await queryCollection(event, 'content')
  .select('path', 'stem', 'title', 'type', 'body')
  .all()
```

### Wiki-Link Extraction

Links are extracted from the parsed `body` using the `extractLinksFromBody()` utility, which traverses the AST looking for `.wiki-link` class attributes.

### Caching Strategy

Only `/api/stats` uses server-side caching:

```typescript
import { defineCachedEventHandler } from 'nitropack/runtime'

export default defineCachedEventHandler(handler, {
  maxAge: 60 * 10,  // 10 minutes
  swr: true,        // Stale-while-revalidate
  name: 'stats',
})
```

Other endpoints return fresh data on each request.
